<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¤Ø´Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ - 2024/2025</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow-x: auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 3px solid #0056b3;
            padding-bottom: 20px;
        }

        .header-text { text-align: right; flex-grow: 1; }
        .logo-container img { max-height: 100px; width: auto; }
        h1 { color: #0056b3; margin: 0; font-size: 24px; font-weight: 700; }
        h2 { color: #555; margin: 5px 0 0 0; font-size: 16px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .admin-panel {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .admin-controls { display: none; gap: 10px; flex-wrap: wrap; }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: bold;
            transition: 0.3s;
            margin-bottom: 5px;
        }

        .btn-login { background: #3498db; color: white; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-save { background: #27ae60; color: white; }
        .btn-reset { background: #f39c12; color: white; font-size: 12px; }
        .btn-new-month { background: #8e44ad; color: white; border: 1px solid #fff; }
        
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
            margin-top: 10px;
        }

        thead { background-color: #0056b3; color: white; }

        th, td {
            padding: 12px 5px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            vertical-align: middle;
        }

        th:first-child, td:first-child,
        th:nth-child(2), td:nth-child(2) {
            position: sticky;
            background-color: #f9f9f9;
            z-index: 2;
            font-weight: bold;
            text-align: right;
            border-left: 2px solid #ddd;
        }
        
        th:first-child, td:first-child { right: 0; }
        th:nth-child(2), td:nth-child(2) { right: 150px; }
        
        thead th:first-child, thead th:nth-child(2) {
            background-color: #004494;
            color: white;
        }

        body.editing-mode .editable {
            border: 2px dashed #3498db;
            cursor: pointer;
            background-color: #f0f8ff;
        }
        
        body.editing-mode th.editable-header {
            border: 2px dashed #f1c40f;
            cursor: pointer;
            background-color: #2980b9;
        }

        .status-ok { color: #28a745; font-weight: bold; font-size: 20px; }
        .status-late { color: #dc3545; font-weight: bold; font-size: 20px; }

        .badge {
            display: inline-block; padding: 4px 10px; border-radius: 12px;
            font-size: 13px; font-weight: bold; color: white;
        }
        .badge-red { background-color: #dc3545; }
        .badge-green { background-color: #28a745; }

        .note-text {
            font-size: 11px; color: #444; background: #fff3cd; 
            padding: 4px; border-radius: 4px; max-width: 200px; margin: auto;
        }

        .legend {
            display: flex; gap: 20px; margin-bottom: 15px; font-size: 14px;
            background: #e9ecef; padding: 10px; border-radius: 5px;
        }

        footer {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;
            text-align: center; font-size: 14px; color: #0056b3; font-weight: bold;
        }
        
        #loader { text-align: center; padding: 20px; font-weight: bold; color: #0056b3; }

        @media print {
            .admin-panel { display: none !important; }
            .container { box-shadow: none; width: 100%; margin: 0; }
            th, td { border: 1px solid #ccc; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="admin-panel">
        <div style="font-weight: bold;">ğŸ”’ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
        <div id="loginSection">
            <button class="btn-login" onclick="adminLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div id="adminControls" class="admin-controls">
            <button class="btn-new-month" onclick="addNewMonthAutomatic()">ğŸ“… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ø¥Ù‚ÙØ§Ù„)</button>
            <button class="btn-save" onclick="saveToFirebase()">â˜ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <button class="btn-reset" onclick="uploadInitialData()">âš  Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Reset)</button>
            <button class="btn-logout" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            <div style="width: 100%; font-size:12px; color:#bdc3c7; margin-top:5px;">
                ØªØ¹Ù„ÙŠÙ…Ø§Øª: Ø§Ù„Ø¹Ø¯Ø¯ "Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©" ÙŠØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø§Ù„Ø¢Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ (âœ˜).
            </div>
        </div>
    </div>

    <header>
        <div class="header-text">
            <h1>Ù…Ø¤Ø´Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù„Ø±ÙØ¹ Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
            <h2>Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©  2025</h2>
        </div>
        <div class="logo-container">
            <img src="TabukCluster.jpeg" alt="Ø´Ø¹Ø§Ø± ØªØ¬Ù…Ø¹ ØªØ¨ÙˆÙƒ Ø§Ù„ØµØ­ÙŠ">
        </div>
    </header>

    <div class="legend">
        <div><span class="status-ok">âœ”</span> ØªÙ… Ø§Ù„Ø±ÙØ¹ / Ù…ÙƒØªÙ…Ù„</div>
        <div><span class="status-late">âœ˜</span> Ù…ØªØ£Ø®Ø± / Ù„Ù… ÙŠØ±Ø¯</div>
        <div><strong>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø­Ù…Ø±:</strong> Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
    </div>

    <div id="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>

    <table id="mainTable" style="display:none;">
        <thead>
            <tr id="headerRow">
                </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <footer>
        ØªÙ… Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨ØªØ¬Ù…Ø¹ ØªØ¨ÙˆÙƒ Ø§Ù„ØµØ­ÙŠ
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAP-wgrP2o6ifi3XuaMK-lBB43nvrs3GfA",
        authDomain: "tabuk-kpi.firebaseapp.com",
        projectId: "tabuk-kpi",
        storageBucket: "tabuk-kpi.firebasestorage.app",
        messagingSenderId: "537604438384",
        appId: "1:537604438384:web:4391b219241c54f7d6f7b5",
        measurementId: "G-9FCG4452CQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    window.currentData = { monthNames: [], rows: [] };
    window.isAdmin = false;

    // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const dataRef = ref(db, 'kpi_data_v2'); 
    onValue(dataRef, (snapshot) => {
        const data = snapshot.val();
        const loader = document.getElementById('loader');
        const table = document.getElementById('mainTable');
        
        if (data && data.rows) {
            window.currentData = data;
            renderTable(data);
            loader.style.display = 'none';
            table.style.display = 'table';
        } else {
            loader.innerHTML = "Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø¶ØºØ· 'Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„' Ù„Ù„Ø¨Ø¯Ø¡.";
        }
    });

    window.saveToFirebase = function() {
        if (!window.isAdmin) return;
        set(ref(db, 'kpi_data_v2'), window.currentData)
            .then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…"); })
            .catch((error) => { alert("Ø®Ø·Ø£: " + error); });
    };

    window.uploadInitialData = function() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„.")) {
            const initialData = {
                monthNames: [
                    "Ø£ÙƒØªÙˆØ¨Ø± 25", "Ø³Ø¨ØªÙ…Ø¨Ø± 25", "Ø£ØºØ³Ø·Ø³ 25", "ÙŠÙˆÙ„ÙŠÙˆ 25", 
                    "ÙŠÙˆÙ†ÙŠÙˆ 25", "Ù…Ø§ÙŠÙˆ 25", "Ø£Ø¨Ø±ÙŠÙ„ 24", "Ù…Ø§Ø±Ø³ 25", 
                    "ÙØ¨Ø±Ø§ÙŠØ± 25", "ÙŠÙ†Ø§ÙŠØ± 25", "Ø¯ÙŠØ³Ù…Ø¨Ø± 24", "Ù†ÙˆÙÙ…Ø¨Ø± 24"
                ],
                rows: [
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø¶Ø¨Ø§ Ø§Ù„Ø¹Ø§Ù…", cont: " Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠ", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ù…Ù„Ø¬ Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø§Ø¨Ù‚Ø©" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚ ØºÙŠØ± Ù…Ù†ØªØ¸Ù…" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø¨Ø¯Ø¹ Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ˜","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "ØªØ£Ø®Ø± Ø§Ù„Ø±ÙØ¹ Ù„Ø´Ù‡Ø± Ø£ÙƒØªÙˆØ¨Ø±" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ø´ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ ØªÙŠÙ…Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ø¨ÙˆØ±Ø§ÙƒØ© Ø§Ù„Ø¹Ø§Ù…", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", cont: "Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰", late: 0, months: ["âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©", cont: " Ø§Ù„Ø¹Ø±ÙØ¬", late: 0, months: ["âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜","âœ˜"], notes: "ÙŠÙ„Ø²Ù… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù‚Ø¯" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯", cont: "Ø±Ø¬Ø¨ ÙˆØ³Ù„Ø³Ù„Ù‡", late: 0, months: ["âœ˜","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "ØªÙ…Ø¯ÙŠØ¯ 10% / Ø´Ø±Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØ§Ù„Ø£Ø·ÙØ§Ù„", cont: "Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ", late: 0, months: ["âœ˜","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "" },
                    { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆØ¬Ù‡", cont: "Ø¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©", late: 0, months: ["âœ˜","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”","âœ”"], notes: "Ù…Ø³ØªØ®Ù„ØµØ§Øª Ø®ØªØ§Ù…ÙŠØ© Ù…ØªØ£Ø®Ø±Ø©" }
                ]
            };
            window.currentData = initialData;
            // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø³ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶
            window.saveToFirebase();
        }
    };

    // --- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ---
    window.addNewMonthAutomatic = function() {
        if (!window.isAdmin) return;

        // 1. Ø­Ø³Ø§Ø¨ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
        const date = new Date();
        date.setMonth(date.getMonth() - 1); 
        
        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        const prevMonthName = monthsAr[date.getMonth()];
        const prevYearShort = date.getFullYear().toString().slice(-2);
        
        const newColumnTitle = `${prevMonthName} ${prevYearShort}`;

        if (window.currentData.monthNames[0] === newColumnTitle) {
            alert(`Ø§Ù„Ø´Ù‡Ø± "${newColumnTitle}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!`);
            return;
        }

        if(!confirm(`Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚): "${newColumnTitle}"\nÙˆØ­Ø°Ù Ø£Ù‚Ø¯Ù… Ø´Ù‡Ø±.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
            return;
        }

        window.currentData.monthNames.unshift(newColumnTitle);
        window.currentData.rows.forEach(row => {
            row.months.unshift("âœ˜");
        });

        if (window.currentData.monthNames.length > 12) {
            window.currentData.monthNames.pop();
            window.currentData.rows.forEach(row => {
                row.months.pop();
            });
        }

        renderTable(window.currentData);
        window.saveToFirebase();
    };

</script>

<script>
    function adminLogin() {
        const pass = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
        if(pass === "1234") {
            window.isAdmin = true;
            document.body.classList.add('editing-mode');
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminControls').style.display = 'flex';
            renderTable(window.currentData);
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
        }
    }

    function renderTable(data) {
        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = `
            <th style="min-width: 150px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</th>
            <th style="min-width: 140px;">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
            <th style="width: 60px;">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</th>
        `;

        if(data.monthNames) {
            data.monthNames.forEach((monthName, index) => {
                let style = index === 0 ? "border-bottom: 3px solid #e74c3c;" : "";
                headerRow.innerHTML += `<th class="editable-header" style="${style}" onclick="editHeader(${index})">${monthName}</th>`;
            });
        }

        headerRow.innerHTML += `<th style="min-width: 200px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</th>`;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if(data.rows) {
            data.rows.forEach((row, rowIndex) => {
                
                // --- Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ØªØ£Ø®Ø±Ø© ---
                // Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø¹Ù„Ø§Ù…Ø§Øª (âœ˜) ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø´Ù‡ÙˆØ±
                let autoLateCount = row.months.filter(m => m.includes('âœ˜')).length;
                row.late = autoLateCount; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                // -------------------------------

                const tr = document.createElement('tr');
                
                tr.innerHTML += `<td>${row.name}</td>`;
                tr.innerHTML += `<td>${row.cont}</td>`;
                
                let badgeClass = row.late > 0 ? 'badge-red' : 'badge-green';
                // Ø¥Ù„ØºØ§Ø¡ onclick Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¢Ù† Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
                tr.innerHTML += `<td><span class="badge ${badgeClass}">${row.late}</span></td>`;

                row.months.forEach((status, monthIndex) => {
                    let statusClass = status.includes('âœ”') ? 'status-ok' : 'status-late';
                    tr.innerHTML += `<td class="editable ${statusClass}" 
                                         ondblclick="toggleStatus(${rowIndex}, ${monthIndex})"
                                         onclick="editMonthText(${rowIndex}, ${monthIndex})">
                                         ${status}
                                     </td>`;
                });

                tr.innerHTML += `<td class="editable note-text" onclick="editCell(${rowIndex}, 'notes')">${row.notes}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    window.editHeader = function(index) {
        if (!window.isAdmin) return;
        let oldVal = window.currentData.monthNames[index];
        let newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±:", oldVal);
        if (newVal !== null) {
            window.currentData.monthNames[index] = newVal;
            renderTable(window.currentData);
        }
    };

    window.editCell = function(rowIndex, field) {
        if (!window.isAdmin) return;
        let oldVal = window.currentData.rows[rowIndex][field];
        let newVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©:", oldVal);
        if (newVal !== null) {
            window.currentData.rows[rowIndex][field] = newVal;
            renderTable(window.currentData);
        }
    };

    window.editMonthText = function(rowIndex, monthIndex) { }

    window.toggleStatus = function(rowIndex, monthIndex) {
        if (!window.isAdmin) return;
        let currentStatus = window.currentData.rows[rowIndex].months[monthIndex];
        if (currentStatus.includes('âœ”')) {
            window.currentData.rows[rowIndex].months[monthIndex] = 'âœ˜';
        } else {
            window.currentData.rows[rowIndex].months[monthIndex] = 'âœ”';
        }
        // Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        renderTable(window.currentData);
    };
</script>

</body>
</html>
